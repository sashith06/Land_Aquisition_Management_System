# Calculated Interest - Data Flow Visualization

## Complete Data Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                           USER INTERFACE                            │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  Compensation Form                                           │  │
│  │  ┌────────────────────────────────────────────┐             │  │
│  │  │ Final Compensation Amount: 1,000,000 LKR   │             │  │
│  │  └────────────────────────────────────────────┘             │  │
│  │  ┌────────────────────────────────────────────┐             │  │
│  │  │ Calculated Interest: 125,041.10 LKR ⚡     │ [Auto-calc] │  │
│  │  └────────────────────────────────────────────┘             │  │
│  │                                                [Save] button  │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  │ 1. User clicks Save
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        FRONTEND (React)                             │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  CompensationDetailsTab.jsx                                  │  │
│  │  ┌────────────────────────────────────────────────────────┐  │  │
│  │  │ handleSaveCompensation()                               │  │  │
│  │  │ ├─ getEditingOwnerInterest() → calculates interest    │  │  │
│  │  │ └─ Creates payload with:                               │  │  │
│  │  │    {                                                    │  │  │
│  │  │      final_compensation_amount: 1000000,               │  │  │
│  │  │      calculated_interest_amount: 125041.10 ← Here!     │  │  │
│  │  │    }                                                    │  │  │
│  │  └────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  │ 2. HTTP POST Request
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    BACKEND API (Express.js)                         │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  compensationPaymentDetailsController.js                     │  │
│  │  ┌────────────────────────────────────────────────────────┐  │  │
│  │  │ createOrUpdatePaymentDetails()                         │  │  │
│  │  │ ├─ Receives req.body.calculated_interest_amount        │  │  │
│  │  │ ├─ Logs: "🧮 Calculated Interest Amount: 125041.10"    │  │  │
│  │  │ └─ Calls Model to save                                 │  │  │
│  │  └────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  │ 3. Save to Database
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    DATABASE MODEL (MySQL)                           │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  compensationPaymentDetailsModel.js                          │  │
│  │  ┌────────────────────────────────────────────────────────┐  │  │
│  │  │ createOrUpdate()                                       │  │  │
│  │  │ ├─ INSERT or UPDATE query                             │  │  │
│  │  │ ├─ Includes calculated_interest_amount in query       │  │  │
│  │  │ └─ Logs: "💰 CALCULATED INTEREST BEING SAVED"         │  │  │
│  │  └────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  │ 4. Write to Database
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       DATABASE (MySQL)                              │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  Table: compensation_payment_details                         │  │
│  │  ┌────────────────────────────────────────────────────────┐  │  │
│  │  │ Column: calculated_interest_amount DECIMAL(15,2)       │  │  │
│  │  │ Value:  125041.10 ← SAVED HERE!                        │  │  │
│  │  └────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════
                        RETRIEVAL FLOW (Later)
═══════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────┐
│                     USER RELOADS PAGE                               │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  │ 5. HTTP GET Request
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    BACKEND API (Express.js)                         │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  compensationPaymentDetailsController.js                     │  │
│  │  ┌────────────────────────────────────────────────────────┐  │  │
│  │  │ getCompensationByLot()                                 │  │  │
│  │  │ ├─ Calls Model.getByLot()                              │  │  │
│  │  │ ├─ Maps result.calculated_interest_amount to response  │  │  │
│  │  │ └─ Logs: "📤 Sending response with calculated..."      │  │  │
│  │  └────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  │ 6. Returns JSON Response
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        FRONTEND (React)                             │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  CompensationDetailsTab.jsx                                  │  │
│  │  ┌────────────────────────────────────────────────────────┐  │  │
│  │  │ loadCompensationData()                                 │  │  │
│  │  │ ├─ Receives data.owner_data[].calculatedInterestAmount │  │  │
│  │  │ ├─ Stores in compensationData state                    │  │  │
│  │  │ └─ Logs: "💰 Calculated Interest Amounts from API"     │  │  │
│  │  └────────────────────────────────────────────────────────┘  │  │
│  │  ┌────────────────────────────────────────────────────────┐  │  │
│  │  │ getOwnerInterest(owner)                                │  │  │
│  │  │ ├─ Checks compensationData[key].calculatedInterest     │  │  │
│  │  │ ├─ Uses stored value if available ✓                    │  │  │
│  │  │ ├─ Logs: "💰 Using stored calculated interest..."      │  │  │
│  │  │ └─ Falls back to calculation if not found              │  │  │
│  │  └────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  │ 7. Display to User
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                           USER INTERFACE                            │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  Compensation Details Display                                │  │
│  │  ┌────────────────────────────────────────────┐             │  │
│  │  │ Final Compensation: 1,000,000 LKR          │             │  │
│  │  └────────────────────────────────────────────┘             │  │
│  │  ┌────────────────────────────────────────────┐             │  │
│  │  │ Calculated Interest: 125,041.10 LKR ✓      │ [From DB!]  │  │
│  │  └────────────────────────────────────────────┘             │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════
                        KEY FEATURES
═══════════════════════════════════════════════════════════════════════

✅ Automatic Calculation
   └─ Frontend calculates interest when compensation is entered

✅ Database Persistence
   └─ Interest amount stored in calculated_interest_amount column

✅ Smart Retrieval
   └─ Frontend uses stored value when available (consistent!)
   └─ Falls back to calculation if stored value doesn't exist

✅ Completion Tracking
   └─ System compares stored interest with total interest paid
   └─ Determines if interest payments are complete

✅ Debug Logging
   └─ Comprehensive logs at every step for troubleshooting

═══════════════════════════════════════════════════════════════════════
                     INTEREST CALCULATION FORMULA
═══════════════════════════════════════════════════════════════════════

    Interest = (Principal × 0.07 × Days) / 365

    Example:
    Principal:      1,000,000 LKR
    Annual Rate:    0.07 (7%)
    Gazette Date:   2024-01-01
    Current Date:   2025-10-14
    Days Elapsed:   652 days

    Interest = (1,000,000 × 0.07 × 652) / 365
    Interest = 125,041.10 LKR

═══════════════════════════════════════════════════════════════════════
